version: '3.8'

services:
  # Phase 2: Orchestrator Bot
  orchestrator:
    build:
      context: .
      dockerfile: docker/Dockerfile.bot
    container_name: spam-arrester-orchestrator
    env_file:
      - bot/.env
    environment:
      - NODE_ENV=production
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - DB_PATH=/app/data/orchestrator.db
      - SESSIONS_DIR=/app/sessions
      - HOST_SESSIONS_DIR=${PWD}/sessions
      - CONFIG_DIR=/app/config
      - HOST_CONFIG_DIR=${PWD}/config
      - DOCKER_SOCKET=/var/run/docker.sock
      - WEB_API_PORT=${WEB_API_PORT:-3000}
    ports:
      # Expose web API/webapp for authentication
      - "${WEB_API_PORT:-3000}:${WEB_API_PORT:-3000}"
    volumes:
      # Access to Docker socket for container management
      - /var/run/docker.sock:/var/run/docker.sock
      # Database persistence
      - ./data:/app/data
      # Sessions directory (mounted into agent containers)
      - ./sessions:/app/sessions
      # Config directory (shared with agent containers)
      - ./config:/app/config
    restart: unless-stopped
    networks:
      - agent-network
    # Run as root for Docker socket access (required for container orchestration)
    # Note: This is acceptable for the orchestrator service which manages other containers
    user: "0:0"
    security_opt:
      - no-new-privileges:true
    # Note: Needs docker socket access, so can't drop all capabilities
    cap_drop:
      - NET_ADMIN
      - SYS_ADMIN

volumes:
  tdlib-data:
    driver: local
  tdlib-files:
    driver: local

networks:
  agent-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.54.0.0/16
