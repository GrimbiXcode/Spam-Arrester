version: '3.8'

services:
  # Phase 2: Orchestrator Bot
  orchestrator:
    build:
      context: .
      dockerfile: docker/Dockerfile.bot
    container_name: spam-arrester-orchestrator
    env_file:
      - bot/.env
    environment:
      - NODE_ENV=production
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - DB_PATH=/app/data/orchestrator.db
      - SESSIONS_DIR=/app/sessions
      - CONFIG_DIR=/app/config
      - DOCKER_SOCKET=/var/run/docker.sock
    volumes:
      # Access to Docker socket for container management
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Database persistence
      - ./data:/app/data
      # Sessions directory (mounted into agent containers)
      - ./sessions:/app/sessions
      # Config directory (shared with agent containers)
      - ./config:/app/config:ro
    restart: unless-stopped
    networks:
      - agent-network
    security_opt:
      - no-new-privileges:true
    # Note: Needs docker socket access, so can't drop all capabilities
    cap_drop:
      - NET_ADMIN
      - SYS_ADMIN

  # Phase 1: Single Agent (for backward compatibility)
  # Remove this when all users migrated to orchestrator
  spam-arrester-agent:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: spam-arrester-agent
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - LOG_LEVEL=${LOG_LEVEL:-info}
    volumes:
      # Persist TDLib session data
      - tdlib-data:/app/tdlib-data
      - tdlib-files:/app/tdlib-files
      # Persist logs
      - ./logs:/app/logs
      # Config
      - ./config:/app/config:ro
    restart: unless-stopped
    networks:
      - agent-network
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    profiles:
      - legacy

volumes:
  tdlib-data:
    driver: local
  tdlib-files:
    driver: local

networks:
  agent-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.54.0.0/16
